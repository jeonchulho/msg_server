global
  log stdout format raw local0
  maxconn 4096

defaults
  mode http
  log global
  option httplog
  timeout connect 5s
  timeout client 30s
  timeout server 30s
  retries 2

resolvers docker
  nameserver dns 127.0.0.11:53
  resolve_retries 3
  timeout resolve 1s
  timeout retry 1s
  hold valid 10s

frontend dbman_front
  bind *:8082
  acl is_read_path path -i /api/v1/db/org-units/list
  acl is_read_path path -i /api/v1/db/users/search
  acl is_read_path path -i /api/v1/db/users/authenticate
  acl is_read_path path -i /api/v1/db/users/aliases/list
  acl is_read_path path -i /api/v1/db/users/aliases/audit
  acl is_read_path path -i /api/v1/db/tenants/list
  acl is_read_path path -i /api/v1/db/tenants/get
  acl is_read_path path -i /api/v1/db/files/search
  acl is_read_path path -i /api/v1/db/rooms/members/check
  acl is_read_path path -i /api/v1/db/messages/list
  acl is_read_path path -i /api/v1/db/messages/search
  acl is_read_path path -i /api/v1/db/messages/readers
  acl is_read_path path -i /api/v1/db/messages/last-read
  acl is_read_path path -i /api/v1/db/messages/unread-count
  acl is_read_path path -i /api/v1/db/messages/unread-counts
  acl is_read_path path -i /api/v1/db/rooms/list
  acl is_read_path path -i /api/v1/db/session/notes/inbox

  use_backend dbman_read_back if is_read_path
  default_backend dbman_write_back

backend dbman_write_back
  balance roundrobin
  option httpchk GET /health/ready
  http-check expect status 200
  server-template dbman-write 10 dbman-write:8082 check resolvers docker init-addr libc,none

backend dbman_read_back
  balance roundrobin
  option httpchk GET /health/ready
  http-check expect status 200
  server-template dbman-read 10 dbman-read:8082 check resolvers docker init-addr libc,none
